#!/usr/bin/env node

/**
 * Setup script for Vertex AI credentials
 * This script helps convert your service account JSON to base64 for environment variables
 */

const fs = require('fs');
const path = require('path');

function setupCredentials() {
    console.log('üîß Vertex AI Credentials Setup\n');

    // Check if service account file exists
    const keyFilePath = path.join(__dirname, '..', 'tejas-vertex-test-key.json');
    
    if (!fs.existsSync(keyFilePath)) {
        console.error('‚ùå Error: tejas-vertex-test-key.json not found in project root');
        console.log('\nPlease ensure your service account key file is named "tejas-vertex-test-key.json"');
        console.log('and is located in the project root directory.\n');
        process.exit(1);
    }

    try {
        // Read the JSON file
        const jsonContent = fs.readFileSync(keyFilePath, 'utf8');
        
        // Validate JSON
        const credentials = JSON.parse(jsonContent);
        
        console.log('‚úÖ Service account file found and validated');
        console.log(`üìã Project ID: ${credentials.project_id}`);
        console.log(`üìã Client Email: ${credentials.client_email}\n`);

        // Convert to base64
        const base64Credentials = Buffer.from(jsonContent).toString('base64');

        // Create .env.local content
        const envContent = `# Vertex AI Configuration (Generated by setup script)
# Generated on: ${new Date().toISOString()}

# Option 1: Base64 encoded credentials (Recommended for cloud deployment)
GOOGLE_APPLICATION_CREDENTIALS_JSON_BASE64=${base64Credentials}

# Option 2: File path (For local development)
# GOOGLE_APPLICATION_CREDENTIALS=./tejas-vertex-test-key.json

# Vertex AI Settings
GOOGLE_CLOUD_PROJECT=${credentials.project_id}
VERTEX_AI_LOCATION=us-central1
VERTEX_AI_MODEL=gemini-2.0-flash-exp

# Model Configuration
NEXT_PUBLIC_RESUME_API_MODEL_TYPE=VertexAI
NEXT_PUBLIC_RESUME_API_MODEL=gemini-2.0-flash-exp
`;

        // Check if .env.local exists
        const envLocalPath = path.join(__dirname, '..', '.env.local');
        const envLocalExists = fs.existsSync(envLocalPath);

        if (envLocalExists) {
            console.log('‚ö†Ô∏è  .env.local already exists');
            console.log('\nYou have two options:');
            console.log('1. Manually add the configuration below to your .env.local file');
            console.log('2. Delete .env.local and run this script again to create a new one\n');
            console.log('='.repeat(80));
            console.log(envContent);
            console.log('='.repeat(80));
        } else {
            // Write to .env.local
            fs.writeFileSync(envLocalPath, envContent);
            console.log('‚úÖ Created .env.local with Vertex AI configuration');
        }

        console.log('\nüìù Next Steps:');
        console.log('1. Review your .env.local file');
        console.log('2. Restart your development server: npm run dev');
        console.log('3. Test the connection: curl -X POST http://localhost:3000/api/test-vertex');
        console.log('\nüìö For more information, see:');
        console.log('   - VERTEX_AI_SETUP.md');
        console.log('   - VERTEX_AI_USAGE_EXAMPLES.md\n');

    } catch (error) {
        console.error('‚ùå Error processing credentials:', error.message);
        process.exit(1);
    }
}

// Run the setup
setupCredentials();

